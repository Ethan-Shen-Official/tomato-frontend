import{d as $,r as x,p as k,o as z,i as f,e as r,w as m,z as D,K as F,L as J,b as o,q as E,c as L,f as O,y as R,v as V,k as p,F as H,J as K,U as Q,E as u,H as W,m as _,ac as j,N as G,W as X,g as Y,u as Z,R as tt,a1 as et,_ as at}from"./index-CcEL__uZ.js";/* empty css                   *//* empty css                  *//* empty css                 *//* empty css                 *//* empty css                        *//* empty css                        *//* empty css                    */import{g as st,u as ot,d as b}from"./cart-CfyEhnxo.js";import{b as nt}from"./product-DfXneN0G.js";/* empty css                       */import"./request-BuipQ3Vl.js";const ct={class:"cart-container"},rt={class:"header-section"},lt={class:"cart-title"},it={class:"cart-items"},dt={class:"checkbox-section"},ut={class:"item-info"},mt={class:"item-title"},pt={class:"price-section"},_t={class:"price-row"},vt={class:"price"},ft={class:"price-row"},yt={class:"price-total"},It={class:"quantity-section"},ht={class:"action-section"},gt={key:0,class:"summary-section"},Ct={class:"total-info"},kt={class:"total-label"},wt={class:"total-amount"},qt=$({__name:"Cart",setup(xt){const y=x(!0),l=x({items:[],total:0,totalAmount:0}),g=a=>a.toFixed(2),B=async a=>{var t;try{if(!((t=a.cartItemIds)!=null&&t.length)){u.error("商品数据异常");return}const[s,...e]=a.cartItemIds;if(await ot({cartItemId:s,quantity:a.quantity}),e.length>0){const c=e.map(d=>b(d).catch(i=>(console.warn(`删除条目 ${d} 失败:`,i),null)));await Promise.all(c)}await h(),u.success("商品数量更新成功")}catch(s){u.error("数量更新失败"),console.error("更新错误:",s),await h()}},M=async a=>{try{await et.confirm("确定移除该商品所有数量吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=a.cartItemIds.map(s=>b(s).catch(e=>(console.warn(`删除 ${s} 失败（可忽略）:`,e),null)));await Promise.all(t),await h(),u.success("已移除商品")}catch(t){t!=="cancel"&&(u.error("操作失败"),console.error(t))}},N=()=>{if(C.value===0){u.warning("请选择要结算的商品");return}u.success(`跳转结算页面，共${C.value}件商品`);const a=I.value.flatMap(s=>s.cartItemIds),t=I.value;sessionStorage.setItem("selectedItems",JSON.stringify(t)),sessionStorage.setItem("selectedCartItemIds",JSON.stringify(a)),W.push({path:"/payment"})},I=k(()=>{var a,t;return((t=(a=l.value)==null?void 0:a.items)==null?void 0:t.filter(s=>s.selected))||[]}),C=k(()=>I.value.reduce((a,t)=>a+t.quantity,0)),A=k(()=>I.value.reduce((a,t)=>a+t.price*t.quantity,0)),h=async()=>{try{y.value=!0;const a=await st();if(a.data.code==="200"){const t=a.data.data.items||[],s=new Map;for(const e of t){const c=await nt(e.productId),d=c.data.code==="200"?c.data.data.amount:0;if(s.has(e.productId)){const i=s.get(e.productId);i.quantity+=e.quantity,i.quantity=Math.min(i.quantity,d),i.cartItemIds.push(e.cartItemId)}else s.set(e.productId,{productId:e.productId,title:e.title,price:e.price,cover:e.cover,quantity:Math.min(e.quantity,d),cartItemIds:[e.cartItemId],selected:!1})}l.value={items:Array.from(s.values()),total:Array.from(s.values()).reduce((e,c)=>e+c.quantity,0),totalAmount:Array.from(s.values()).reduce((e,c)=>e+c.price*c.quantity,0)}}}catch(a){console.error("Error fetching cart items:",a)}finally{y.value=!1}};return z(()=>{console.log("组件挂载"),h()}),(a,t)=>{const s=R,e=O("router-link"),c=j,d=G,i=X,S=Y,P=Q,T=D,U=J;return _(),f("div",ct,[r(T,{class:"cart-card"},{default:m(()=>{var w,q;return[F((_(),f("div",null,[o("div",rt,[r(e,{to:"/all"},{default:m(({navigate:n})=>[r(s,{onClick:n,type:"primary",plain:""},{default:m(()=>t[0]||(t[0]=[V(" 返回商品列表 ")])),_:2},1032,["onClick"])]),_:1}),o("h1",lt,"我的购物车（"+p(((w=l.value)==null?void 0:w.total)||0)+"件）",1)]),o("div",it,[(_(!0),f(H,null,K((q=l.value)==null?void 0:q.items,n=>(_(),f("div",{key:n.productId,class:"cart-item"},[o("div",dt,[r(c,{modelValue:n.selected,"onUpdate:modelValue":v=>n.selected=v},null,8,["modelValue","onUpdate:modelValue"])]),r(d,{src:n.cover,class:"item-image",fit:"cover"},null,8,["src"]),o("div",ut,[o("h3",mt,p(n.title),1)]),o("div",pt,[o("div",_t,[t[1]||(t[1]=o("span",{class:"label"},"单价：",-1)),o("span",vt,"¥"+p(g(n.price)),1)]),o("div",ft,[t[2]||(t[2]=o("span",{class:"label"},"小计：",-1)),o("span",yt,"¥"+p(g(n.price*n.quantity)),1)])]),o("div",It,[r(i,{modelValue:n.quantity,"onUpdate:modelValue":v=>n.quantity=v,min:1,precision:0,size:"small",onChange:v=>B(n)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),o("div",ht,[r(s,{type:"danger",size:"small",onClick:v=>M(n),circle:""},{default:m(()=>[r(S,null,{default:m(()=>[r(Z(tt))]),_:1})]),_:2},1032,["onClick"])])]))),128))]),l.value&&l.value.total>0?(_(),f("div",gt,[o("div",Ct,[o("span",kt,"已选 "+p(C.value)+" 件商品，合计：",1),o("span",wt,"¥"+p(g(A.value)),1)]),r(s,{type:"danger",size:"large",onClick:N},{default:m(()=>t[3]||(t[3]=[V(" 去结算 ")])),_:1})])):E("",!0),!y.value&&(!l.value||l.value.total===0)?(_(),L(P,{key:1,description:"您的购物车还没有商品哦～"})):E("",!0)])),[[U,y.value]])]}),_:1})])}}}),zt=at(qt,[["__scopeId","data-v-544e568a"]]);export{zt as default};
